<div class="patient-report-container">
    <h2>New Report</h2>
    
    <mat-horizontal-stepper [linear]="true" #stepper [selectedIndex]="currentStep">
      <!-- Step 1: Patient Details -->
      <mat-step><!-- [completed]="detailsForm.valid"> -->
        <form [formGroup]="detailsForm">
          <ng-template matStepLabel>Patient Details</ng-template>   
                 
          @for (dc of detail_controls; track dc) {
            <div class="form-row">
              <app-dynamic-form-control [control]="dc" [form]="detailsForm">
              </app-dynamic-form-control>
            </div>
          }
        </form>
        
        <!-- <form [formGroup]="detailsForm">
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Patient Number</mat-label>
              <input type="text" matInput formControlName="hospitalNumber" (input)="filterPatients($event)">
              <!-- <mat-autocomplete #auto="matAutocomplete">
                <mat-option *ngFor="let patient of filteredPatients" [value]="patient.id">
                  {{ patient.id }} - {{ patient.name }}
                </mat-option>
              </mat-autocomplete>  --
                @if (detailsForm.controls['hospitalNumber'].errors?.['required']) {
                    <mat-error>Hospital Number is required</mat-error>
                }              
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Histology Number</mat-label>
              <input type="text" matInput formControlName="histologyNumber">
                @if (detailsForm.controls['histologyNumber'].errors?.['required']) {
                    <mat-error>Histology Number is required</mat-error>
                }              
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Referring Clinician</mat-label>
              <mat-select formControlName="referringClinician">
                @for (clinician of clinicians; track clinician.id) {
                    <mat-option [value]="clinician">{{ clinician.name }}</mat-option>
                }
              </mat-select>
                @if (detailsForm.controls['referringClinician'].errors?.['required']) {
                    <mat-error>Referring clinician is required</mat-error>
                }
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Date of Reporting</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="reportingDate">
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
                @if (detailsForm.controls['reportingDate'].errors?.['required']) {
                    <mat-error>Date of reporting is required</mat-error>
                }              
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Side</mat-label>
              <mat-select formControlName="side">
                @for (side of laterality_options; track side) {
                    <mat-option [value]="side">{{ side }}</mat-option>
                }
              </mat-select>
              @if (detailsForm.controls['side'].errors?.['required']) {
                    <mat-error>Side is required</mat-error>
                }
            </mat-form-field>
          </div>
        </form> -->
        
        <div class="button-row">
          <button mat-raised-button color="primary" (click)="nextStep()">Next</button>
        </div>
      </mat-step>
      
      <!-- Step 2: Macroscopy -->
      <mat-step [completed]="macroscopyForm.valid">
        <ng-template matStepLabel>Macroscopy</ng-template>
        <form [formGroup]="macroscopyForm">
          <div class="form-section">
            <h3>Specimen Type</h3>
            <div class="checkbox-group" formArrayName="specimenTypes">
                @for (stype of specimen_type_options; track stype) {
                  <mat-checkbox [value]="stype">{{ stype }}</mat-checkbox>
                }
            </div>
          </div>
          
          <div class="form-section">
            <h3>Specimen Dimensions (mm)</h3>
            <div class="dimensions-container-4">
              <mat-form-field appearance="outline">
                <mat-label>Length (x)</mat-label>
                <input type="number" matInput formControlName="dimensions_x">
                @if (macroscopyForm.controls['dimensions_x'].errors?.['required']) {
                    <mat-error>Length is required</mat-error>
                }
                @if (macroscopyForm.controls['dimensions_x'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>Width (y)</mat-label>
                <input type="number" matInput formControlName="dimensions_y">
                @if (macroscopyForm.controls['dimensions_y'].errors?.['required']) {
                    <mat-error>Width is required</mat-error>
                }
                @if (macroscopyForm.controls['dimensions_y'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>Height (z)</mat-label>
                <input type="number" matInput formControlName="dimensions_z">
                @if (macroscopyForm.controls['dimensions_z'].errors?.['required']) {
                    <mat-error>Height is required</mat-error>
                }
                @if (macroscopyForm.controls['dimensions_z'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Weight</mat-label>
                <input type="number" matInput formControlName="weight">
                  @if (macroscopyForm.controls['weight'].errors?.['required']) {
                      <mat-error>Weight is required</mat-error>
                  }
                  @if (macroscopyForm.controls['weight'].errors?.['min']) {
                      <mat-error>Value must be positive</mat-error>
                  }
              </mat-form-field>
            </div>
          </div>
          
          <div class="form-section">
            <h3>Axillary Procedure</h3>
            <div class="checkbox-group" formArrayName="axillaryProcedure">
                @for (ap of axillary_procedure_options; track ap) {
                    <mat-checkbox [value]="ap">{{ ap | titlecase }}</mat-checkbox>
                }
            </div>
          </div>
        </form> 
        
        <div class="button-row">
          <button mat-button (click)="previousStep()">Back</button>
          <button mat-raised-button color="primary" (click)="nextStep()">Next</button>          
        </div>
      </mat-step>

      <!-- Step 3: Microscopy -->
      <mat-step [completed]="microscopyForm.valid">
        <ng-template matStepLabel>Microscopy</ng-template>
        <form [formGroup]="microscopyForm">
          <div class="form-section">
            <h3>In-situ Carcinoma</h3>
            <div class="dimensions-container">
              <mat-form-field appearance="outline">
                <mat-label>Dual Carcinoma In-situ (DCIS) size</mat-label>
                <input type="number" matInput formControlName="dcis">
                @if (microscopyForm.controls['dcis'].errors?.['required']) {
                    <mat-error>DCIS size is required</mat-error>
                }
                @if (microscopyForm.controls['dcis'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <div class="checkbox-group" formArrayName="in_situ_carcinoma">
                @for (ic of in_situ_carcinoma_options; track ic) {
                  <mat-checkbox [value]="ic">{{ ic | titlecase }}</mat-checkbox>
                }
              </div>

              <mat-checkbox>Microinvasion Present</mat-checkbox>
              
              <mat-checkbox>Invasive Carcinoma Present</mat-checkbox>

              <mat-form-field appearance="outline">
                <mat-label>Invasive tumor size (mm)</mat-label>
                <input type="number" matInput formControlName="invasive_tumor_size">            
                @if (microscopyForm.controls['invasive_tumor_size'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Whole size tumor (mm)</mat-label>
                <input type="number" matInput formControlName="whole_tumor_size">            
                @if (microscopyForm.controls['whole_tumor_size'].errors?.['min']) {
                  <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Invasive Carcinoma Type</mat-label>
                <mat-select formControlName="invasive_carcinoma_type">
                  @for (ic_type of invasive_carcinoma_options; track ic_type) {
                    <mat-option [value]="ic_type">{{ ic_type }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Invasive Grade</mat-label>
                <mat-select formControlName="invasive_carcinoma_type">
                  @for (ig of invasive_grades_options; track ig) {
                    <mat-option [value]="ig">{{ ig }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Tumor Extent</mat-label>
                <mat-select formControlName="invasive_carcinoma_type">
                  @for (ig of invasive_grades_options; track ig) {
                    <mat-option [value]="ig">{{ ig }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </form>

        <div class="button-row">
          <button mat-button (click)="previousStep()">Back</button>
          <button mat-raised-button color="primary" (click)="nextStep()">Next</button>
          <button mat-raised-button color="primary" (click)="submitReport()">Submit</button>
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  </div>