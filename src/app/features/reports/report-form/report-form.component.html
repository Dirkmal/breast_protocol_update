<div class="patient-report-container">
    <h2>New Report</h2>
    
    <mat-horizontal-stepper [linear]="true" #stepper [selectedIndex]="currentStep">
      <!-- Step 1: Patient Details -->
      <mat-step><!-- [completed]="detailsForm.valid"> -->
        <form [formGroup]="detailsForm">
          <ng-template matStepLabel>Patient Details</ng-template>   

          @for (dc of detail_controls; track dc) {
            <div class="form-row">
              <app-dynamic-form-control [control]="dc" [form]="detailsForm">
              </app-dynamic-form-control>
            </div>
          }
        </form>
        
        <div class="button-row">
          <button mat-raised-button color="primary" (click)="nextStep()">Next</button>
        </div>
      </mat-step>
      
      <!-- Step 2: Macroscopy -->
      <mat-step>
        <form [formGroup]="macroscopyForm">
          <ng-template matStepLabel>Macroscopy</ng-template>   

          <div class="form-section">
            <h3>Specimen Type</h3>
            <div class="checkbox-group">
              @for (st of specimen_type_controls; track st) {
                <app-dynamic-form-control [control]="st" [form]="specimen_typeSF">
                </app-dynamic-form-control>
              }
            </div>
          </div>

          <div class="form-section">
            <h3>Specimen Dimensions (mm)</h3>
            <div class="dimensions-container-4">
              @for (sd of specimen_dimension_controls; track sd) {
                <app-dynamic-form-control [control]="sd" [form]="specimen_dimSF">
                </app-dynamic-form-control>
              }
            </div>
          </div>

          <div class="form-section">
            <h3>Axillary Procedure</h3>
              <div class="checkbox-group">
                @for (ap of axillary_procedure_controls; track ap) {
                  <app-dynamic-form-control [control]="ap" [form]="axillary_proSF">
                  </app-dynamic-form-control>
                }
              </div>
          </div>
        </form>
        
        <div class="button-row">
          <button mat-raised-button color="primary" (click)="nextStep()">Next</button>
        </div>
      </mat-step>

      <!-- Step 3: Microscopy -->
      <mat-step [completed]="microscopyForm.valid">
        <ng-template matStepLabel>Microscopy</ng-template>
        <form [formGroup]="microscopyForm">
          <div class="form-section">
            <h3>In-situ Carcinoma</h3>
            <div class="dimensions-container">
              <mat-form-field appearance="outline">
                <mat-label>Dual Carcinoma In-situ (DCIS) size</mat-label>
                <input type="number" matInput formControlName="dcis">
                @if (microscopyForm.controls['dcis'].errors?.['required']) {
                    <mat-error>DCIS size is required</mat-error>
                }
                @if (microscopyForm.controls['dcis'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <div class="checkbox-group" formArrayName="in_situ_carcinoma">
                @for (ic of in_situ_carcinoma_options; track ic) {
                  <mat-checkbox [value]="ic">{{ ic | titlecase }}</mat-checkbox>
                }
              </div>

              <mat-checkbox>Microinvasion Present</mat-checkbox>
              
              <mat-checkbox>Invasive Carcinoma Present</mat-checkbox>

              <mat-form-field appearance="outline">
                <mat-label>Invasive tumor size (mm)</mat-label>
                <input type="number" matInput formControlName="invasive_tumor_size">            
                @if (microscopyForm.controls['invasive_tumor_size'].errors?.['min']) {
                    <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Whole size tumor (mm)</mat-label>
                <input type="number" matInput formControlName="whole_tumor_size">            
                @if (microscopyForm.controls['whole_tumor_size'].errors?.['min']) {
                  <mat-error>Value must be positive</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Invasive Carcinoma Type</mat-label>
                <mat-select formControlName="invasive_carcinoma_type">
                  @for (ic_type of invasive_carcinoma_options; track ic_type) {
                    <mat-option [value]="ic_type">{{ ic_type }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Invasive Grade</mat-label>
                <mat-select formControlName="invasive_carcinoma_type">
                  @for (ig of invasive_grades_options; track ig) {
                    <mat-option [value]="ig">{{ ig }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Tumor Extent</mat-label>
                <mat-select formControlName="invasive_carcinoma_type">
                  @for (ig of invasive_grades_options; track ig) {
                    <mat-option [value]="ig">{{ ig }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </form>

        <div class="button-row">
          <button mat-button (click)="previousStep()">Back</button>
          <button mat-raised-button color="primary" (click)="nextStep()">Next</button>
          <button mat-raised-button color="primary" (click)="submitReport()">Submit</button>
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  </div>